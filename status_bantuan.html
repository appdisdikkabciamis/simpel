<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Status Bantuan - SIMPEL</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Lexend', sans-serif;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-[#111418] dark:text-white overflow-hidden h-screen flex">

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed inset-y-0 left-0 z-50 w-64 bg-white dark:bg-[#1a2634] flex flex-col h-full border-r border-[#e5e7eb] dark:border-[#2a3848] shrink-0 transition-transform duration-300 -translate-x-full md:translate-x-0 md:static">
        <div class="h-auto py-6 flex flex-row items-center justify-center gap-3 px-6 shrink-0 relative">
            <div class="size-10 rounded-full bg-primary flex items-center justify-center text-white shrink-0 shadow-md">
                <span class="text-xl font-bold font-display">S</span>
            </div>
            <h1 class="text-2xl font-bold tracking-tight text-[#111418] dark:text-white">SIMPEL</h1>
            <button onclick="document.getElementById('sidebar').classList.add('-translate-x-full')"
                class="absolute right-4 top-4 md:hidden text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <nav class="flex-1 overflow-y-auto px-4 py-2 flex flex-col gap-2">
            <a class="flex items-center gap-3 px-3 py-3 rounded-lg text-[#637588] dark:text-[#94a3b8] hover:bg-[#f0f2f4] dark:hover:bg-[#2a3848] transition-colors group"
                href="dashboard.html">
                <span class="material-symbols-outlined group-hover:text-primary transition-colors">dashboard</span>
                <span class="text-sm font-medium">Beranda</span>
            </a>

            <!-- Dropdown Menu Proposal -->
            <div class="space-y-1">
                <button
                    onclick="document.getElementById('menuProposal').classList.toggle('hidden'); document.getElementById('arrowProposal').classList.toggle('rotate-180')"
                    class="w-full flex items-center justify-between px-3 py-3 rounded-lg bg-[#f0f2f4] dark:bg-[#2a3848] text-[#111418] dark:text-white transition-colors group">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary">folder_shared</span>
                        <span class="text-sm font-medium">Proposal</span>
                    </div>
                    <span id="arrowProposal"
                        class="material-symbols-outlined text-lg transition-transform duration-200 rotate-180">expand_more</span>
                </button>
                <!-- Submenu (Expanded by default for active page) -->
                <div id="menuProposal" class="pl-11 pr-3 space-y-1">
                    <a class="block px-3 py-2 rounded-lg text-sm text-[#637588] dark:text-[#94a3b8] hover:text-primary hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors"
                        href="daftar_proposal.html">Daftar Proposal</a>
                    <a class="block px-3 py-2 rounded-lg text-sm bg-primary text-white shadow-sm transition-colors"
                        href="status_bantuan.html">Status Bantuan</a>
                    <a class="block px-3 py-2 rounded-lg text-sm text-[#637588] dark:text-[#94a3b8] hover:text-primary hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors"
                        href="statistik_proposal.html">Statistik</a>
                </div>
            </div>

            <a class="flex items-center gap-3 px-3 py-3 rounded-lg text-[#637588] dark:text-[#94a3b8] hover:bg-[#f0f2f4] dark:hover:bg-[#2a3848] transition-colors group"
                href="#">
                <span class="material-symbols-outlined group-hover:text-primary transition-colors">analytics</span>
                <span class="text-sm font-medium">Laporan</span>
            </a>
            <div class="h-px bg-[#e5e7eb] dark:bg-[#2a3848] my-2 mx-3"></div>
            <a class="flex items-center gap-3 px-3 py-3 rounded-lg text-[#637588] dark:text-[#94a3b8] hover:bg-[#f0f2f4] dark:hover:bg-[#2a3848] transition-colors group"
                href="#">
                <span class="material-symbols-outlined group-hover:text-primary transition-colors">settings</span>
                <span class="text-sm font-medium">Pengaturan</span>
            </a>
            <a class="flex items-center gap-3 px-3 py-3 rounded-lg text-red-500 hover:bg-red-50 dark:hover:bg-red-900/10 transition-colors group"
                href="#" onclick="confirmLogout(event)">
                <span class="material-symbols-outlined">logout</span>
                <span class="text-sm font-medium">Keluar</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        <header
            class="h-16 bg-white dark:bg-[#1a2634] border-b border-[#e5e7eb] dark:border-[#2a3848] flex items-center justify-between px-6 shrink-0 z-10">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()"
                    class="p-1 -ml-2 text-[#637588] hover:bg-gray-100 rounded-lg dark:text-[#94a3b8] dark:hover:bg-[#2a3848] transition-colors">
                    <span class="material-symbols-outlined">menu</span>
                </button>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-sm font-semibold text-[#111418] dark:text-white">Administrator</span>
                <div class="size-8 rounded-full bg-blue-100 flex items-center justify-center text-primary">
                    <span class="material-symbols-outlined text-[20px]">person</span>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-auto px-4 md:px-8 pb-24 scroll-smooth relative">
            <div class="mt-8 mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
                <h2 class="text-2xl font-bold text-[#111418] dark:text-white">Status Bantuan Proposal</h2>
                <div class="flex gap-3 w-full md:w-auto">
                    <button onclick="exportExcel()"
                        class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all shadow-md active:scale-95 w-full md:w-auto justify-center">
                        <span class="material-symbols-outlined text-[18px]">table_view</span>
                        Excel
                    </button>
                    <button onclick="exportPDF()"
                        class="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all shadow-md active:scale-95 w-full md:w-auto justify-center">
                        <span class="material-symbols-outlined text-[18px]">picture_as_pdf</span>
                        PDF
                    </button>
                </div>
            </div>

            <!-- Stats Cards Removed and Moved to Statistik Proposal -->

            <div
                class="bg-white dark:bg-[#1a2634] rounded-xl border border-[#e5e7eb] dark:border-[#2a3848] shadow-sm flex flex-col mb-4 md:mb-8">

                <!-- Table Controls -->
                <div
                    class="p-4 border-b border-[#e5e7eb] dark:border-[#2a3848] flex flex-col md:flex-row items-center justify-between gap-4 shrink-0">
                    <div
                        class="flex items-center gap-2 text-sm text-[#637588] dark:text-[#94a3b8] w-full md:w-auto justify-center md:justify-start">
                        <span>Tampilkan</span>
                        <select id="entriesSelect"
                            class="border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 rounded-lg text-sm focus:ring-primary focus:border-primary">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="-1">Semua</option>
                        </select>
                        <span>entri</span>
                    </div>

                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <!-- Filter Kecamatan -->
                        <select id="filterKecamatan"
                            class="border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 rounded-lg text-sm focus:ring-primary focus:border-primary transition-all shadow-sm">
                            <option value="">Semua Kecamatan</option>
                        </select>

                        <!-- Filter Status -->
                        <select id="filterStatus"
                            class="border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 rounded-lg text-sm focus:ring-primary focus:border-primary transition-all shadow-sm">
                            <option value="">Semua Status</option>
                            <option value="penerima">Penerima Bantuan</option>
                            <option value="belum">Belum Menerima</option>
                        </select>

                        <!-- Column Visibility Toggle -->
                        <div class="relative">
                            <button onclick="document.getElementById('columnMenu').classList.toggle('hidden')"
                                class="flex items-center gap-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 text-[#637588] dark:text-[#94a3b8] px-3 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm">
                                <span class="material-symbols-outlined text-[20px]">view_column</span>
                                <span class="hidden sm:inline">Kolom</span>
                            </button>
                            <!-- Dropdown Menu -->
                            <div id="columnMenu"
                                class="hidden absolute right-0 mt-2 w-56 bg-white dark:bg-[#1a2634] rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 z-50 p-2 space-y-1">
                                <label
                                    class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer">
                                    <input type="checkbox" checked onclick="toggleColumn(0)"
                                        class="rounded border-gray-300 text-primary focus:ring-primary"><span
                                        class="text-sm text-gray-700 dark:text-gray-300">No</span>
                                </label>
                                <label
                                    class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer">
                                    <input type="checkbox" checked onclick="toggleColumn(1)"
                                        class="rounded border-gray-300 text-primary focus:ring-primary"><span
                                        class="text-sm text-gray-700 dark:text-gray-300">NPSN</span>
                                </label>
                                <label
                                    class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer">
                                    <input type="checkbox" checked onclick="toggleColumn(2)"
                                        class="rounded border-gray-300 text-primary focus:ring-primary"><span
                                        class="text-sm text-gray-700 dark:text-gray-300">Nama Sekolah</span>
                                </label>
                                <label
                                    class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer">
                                    <input type="checkbox" checked onclick="toggleColumn(3)"
                                        class="rounded border-gray-300 text-primary focus:ring-primary"><span
                                        class="text-sm text-gray-700 dark:text-gray-300">Kecamatan</span>
                                </label>
                                <label
                                    class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer">
                                    <input type="checkbox" onclick="toggleColumn(4)"
                                        class="rounded border-gray-300 text-primary focus:ring-primary"><span
                                        class="text-sm text-gray-700 dark:text-gray-300">Tanggal Proposal</span>
                                </label>
                                <label
                                    class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer">
                                    <input type="checkbox" onclick="toggleColumn(5)"
                                        class="rounded border-gray-300 text-primary focus:ring-primary"><span
                                        class="text-sm text-gray-700 dark:text-gray-300">Tanggal Diterima</span>
                                </label>
                                <label
                                    class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer">
                                    <input type="checkbox" checked onclick="toggleColumn(6)"
                                        class="rounded border-gray-300 text-primary focus:ring-primary"><span
                                        class="text-sm text-gray-700 dark:text-gray-300">Judul Proposal</span>
                                </label>
                                <label
                                    class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer">
                                    <input type="checkbox" checked onclick="toggleColumn(7)"
                                        class="rounded border-gray-300 text-primary focus:ring-primary"><span
                                        class="text-sm text-gray-700 dark:text-gray-300">Status Bantuan</span>
                                </label>
                                <label
                                    class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer">
                                    <input type="checkbox" checked onclick="toggleColumn(8)"
                                        class="rounded border-gray-300 text-primary focus:ring-primary"><span
                                        class="text-sm text-gray-700 dark:text-gray-300">Sumber Dana</span>
                                </label>
                                <label
                                    class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer">
                                    <input type="checkbox" checked onclick="toggleColumn(9)"
                                        class="rounded border-gray-300 text-primary focus:ring-primary"><span
                                        class="text-sm text-gray-700 dark:text-gray-300">Kegiatan</span>
                                </label>
                            </div>
                        </div>

                        <!-- Search Input -->
                        <div class="relative flex-1">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-[20px]">search</span>
                            <input type="text" id="searchInput" placeholder="Cari..."
                                class="pl-10 pr-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm focus:ring-primary focus:border-primary transition-all w-full">
                        </div>
                    </div>
                </div>

                <!-- Table Wrapper -->
                <div class="overflow-x-auto rounded-lg border border-[#e5e7eb] dark:border-[#2a3848]">
                    <table class="w-full text-left text-sm relative border-collapse" id="proposalTable">
                        <thead
                            class="sticky top-0 z-10 bg-[#f8fafc] dark:bg-[#0f172a] text-[#637588] dark:text-[#94a3b8] shadow-sm outline outline-1 outline-[#e5e7eb] dark:outline-[#2a3848]">
                            <tr>
                                <th class="px-3 py-3 font-medium cursor-pointer select-none group"
                                    onclick="sortTable('no')">
                                    <div class="flex items-center gap-1">No <span
                                            class="material-symbols-outlined text-[16px] text-gray-400 group-hover:text-primary transition-colors sort-icon"
                                            id="sort-no">unfold_more</span></div>
                                </th>
                                <th class="px-3 py-3 font-medium cursor-pointer select-none group"
                                    onclick="sortTable('npsn')">
                                    <div class="flex items-center gap-1">NPSN <span
                                            class="material-symbols-outlined text-[16px] text-gray-400 group-hover:text-primary transition-colors sort-icon"
                                            id="sort-npsn">unfold_more</span></div>
                                </th>
                                <th class="px-3 py-3 font-medium cursor-pointer select-none group"
                                    onclick="sortTable('nama')">
                                    <div class="flex items-center gap-1">Nama Sekolah <span
                                            class="material-symbols-outlined text-[16px] text-gray-400 group-hover:text-primary transition-colors sort-icon"
                                            id="sort-nama">unfold_more</span></div>
                                </th>
                                <th class="px-3 py-3 font-medium cursor-pointer select-none group"
                                    onclick="sortTable('kecamatan')">
                                    <div class="flex items-center gap-1">Kecamatan <span
                                            class="material-symbols-outlined text-[16px] text-gray-400 group-hover:text-primary transition-colors sort-icon"
                                            id="sort-kecamatan">unfold_more</span></div>
                                </th>
                                <th class="px-3 py-3 font-medium cursor-pointer select-none group hidden"
                                    onclick="sortTable('tgl_prop')">
                                    <div class="flex items-center gap-1">Tgl Prop. <span
                                            class="material-symbols-outlined text-[16px] text-gray-400 group-hover:text-primary transition-colors sort-icon"
                                            id="sort-tgl_prop">unfold_more</span></div>
                                </th>
                                <th class="px-3 py-3 font-medium cursor-pointer select-none group hidden"
                                    onclick="sortTable('tgl_terima')">
                                    <div class="flex items-center gap-1">Tgl Terima <span
                                            class="material-symbols-outlined text-[16px] text-gray-400 group-hover:text-primary transition-colors sort-icon"
                                            id="sort-tgl_terima">unfold_more</span></div>
                                </th>
                                <th class="px-3 py-3 font-medium cursor-pointer select-none group"
                                    onclick="sortTable('judul')">
                                    <div class="flex items-center gap-1">Judul Proposal <span
                                            class="material-symbols-outlined text-[16px] text-gray-400 group-hover:text-primary transition-colors sort-icon"
                                            id="sort-judul">unfold_more</span></div>
                                </th>
                                <th class="px-3 py-3 font-medium cursor-pointer select-none group"
                                    onclick="sortTable('status')">
                                    <div class="flex items-center gap-1">Status Bantuan <span
                                            class="material-symbols-outlined text-[16px] text-gray-400 group-hover:text-primary transition-colors sort-icon"
                                            id="sort-status">unfold_more</span></div>
                                </th>
                                <th class="px-3 py-3 font-medium cursor-pointer select-none group"
                                    onclick="sortTable('sumber')">
                                    <div class="flex items-center gap-1">Sumber Dana <span
                                            class="material-symbols-outlined text-[16px] text-gray-400 group-hover:text-primary transition-colors sort-icon"
                                            id="sort-sumber">unfold_more</span></div>
                                </th>
                                <th class="px-3 py-3 font-medium cursor-pointer select-none group"
                                    onclick="sortTable('kegiatan')">
                                    <div class="flex items-center gap-1">Kegiatan <span
                                            class="material-symbols-outlined text-[16px] text-gray-400 group-hover:text-primary transition-colors sort-icon"
                                            id="sort-kegiatan">unfold_more</span></div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-[#e5e7eb] dark:divide-[#2a3848]">
                            <tr>
                                <td colspan="7" class="px-5 py-4 text-center">Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>


                <!-- Pagination -->
                <div
                    class="p-4 border-t border-[#e5e7eb] dark:border-[#2a3848] flex flex-col md:flex-row items-center justify-between gap-4">
                    <div class="text-sm text-[#637588] dark:text-[#94a3b8] text-center md:text-left" id="tableInfo">
                        Menampilkan 0 sampai 0 dari 0 entri
                    </div>
                    <div class="flex gap-2 w-full md:w-auto justify-center">
                        <button id="btnPrev" disabled
                            class="px-4 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:bg-gray-100 text-sm font-medium text-gray-700 transition-all shadow-sm">Sebelumnya</button>
                        <button id="btnNext" disabled
                            class="px-4 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:bg-gray-100 text-sm font-medium text-gray-700 transition-all shadow-sm">Selanjutnya</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-5 right-5 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzxvd3NXMiJOT9TYoyGB8lvHIY4h64ABVGVvL-lAq_zegrZ3-vry4YLplYjDUSIf9SiDQ/exec";

        // Data Store
        let proposalData = [];
        let bantuanDataMap = {}; // NPSN -> {npsn, sumberDana, kegiatan}

        let filteredRows = [];
        let currentPage = 1;
        let rowsPerPage = 10;

        let currentSort = { col: 'status', dir: 'desc' }; // Default sort: Status Desc (Penerima first)

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth >= 768) {
                sidebar.classList.toggle('hidden');
            } else {
                sidebar.classList.toggle('-translate-x-full');
            }
        }

        // Fetch Data
        async function fetchData() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '<tr><td colspan="8" class="px-5 py-4 text-center">Sedang mengambil data terbaru...</td></tr>';

            // Independent state
            let loadedProposals = false;
            let loadedBantuan = false;

            try {
                // Fetch Proposals
                const pProp = fetch(API_URL + "?action=baca")
                    .then(r => r.json())
                    .then(res => {
                        if (res.status === 'success') {
                            proposalData = res.data.slice().reverse();
                            loadedProposals = true;
                        } else {
                            console.error("Proposal API Error:", res);
                        }
                    })
                    .catch(e => console.error("Proposal Fetch Error:", e));

                // Fetch Bantuan (Non-blocking for table, but needed for badges)
                const pBan = fetch(API_URL + "?action=get_data_bantuan")
                    .then(r => r.json())
                    .then(res => {
                        if (res.status === 'success') {
                            const bantuanList = res.data || [];
                            bantuanDataMap = {};
                            bantuanList.forEach(item => {
                                const npsn = item.npsn ? String(item.npsn).trim() : null;
                                if (npsn) {
                                    if (!bantuanDataMap[npsn]) {
                                        bantuanDataMap[npsn] = { sumberDana: [], kegiatan: [] };
                                    }
                                    if (item.sumberDana && !bantuanDataMap[npsn].sumberDana.includes(item.sumberDana)) {
                                        bantuanDataMap[npsn].sumberDana.push(item.sumberDana);
                                    }
                                    if (item.kegiatan && !bantuanDataMap[npsn].kegiatan.includes(item.kegiatan)) {
                                        bantuanDataMap[npsn].kegiatan.push(item.kegiatan);
                                    }
                                }
                            });
                            loadedBantuan = true;
                        } else {
                            console.error("Bantuan API Error:", res);
                        }
                    })
                    .catch(e => console.error("Bantuan Fetch Error:", e));

                // Wait for all
                await Promise.all([pProp, pBan]);

                if (loadedProposals) {
                    calculateStats();
                    populateKecamatanFilter();
                    filterDataAndRender();

                    if (!loadedBantuan) {
                        // Optional: Show toast warning "Data bantuan gagal dimuat sebagian"
                        console.warn("Data bantuan tidak termuat penuh.");
                    }
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" class="px-5 py-4 text-center text-red-500">Gagal mengambil data proposal. Silakan muat ulang.</td></tr>';
                }

            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="8" class="px-5 py-4 text-center text-red-500">Error: ${err.message}.<br>Silakan refresh atau lapor admin.</td></tr>`;
            }
        }

        function calculateStats() {
            let total = proposalData.length;
            let realized = 0;

            proposalData.forEach(row => {
                let npsn = '';
                const len = row.length;
                if (len >= 7) npsn = row[3];
                else if (len >= 6 && !isNaN(row[3])) npsn = row[3];

                if (npsn && bantuanDataMap[String(npsn).trim()]) {
                    realized++;
                }
            });

            let pending = total - realized;

            animateValue("countTotal", total, 1000);
            animateValue("countRealized", realized, 1000);
            animateValue("countPending", pending, 1000);
        }

        function animateValue(id, end, duration) {
            const obj = document.getElementById(id);
            let start = 0;
            if (end === 0) {
                obj.innerHTML = "0";
                return;
            }
            let range = end - start;
            let current = start;
            let increment = end > start ? 1 : -1;
            let stepTime = Math.abs(Math.floor(duration / range));

            // Limit speed for large numbers
            if (stepTime < 10) {
                stepTime = 10;
                increment = Math.ceil(range / (duration / 10));
            }

            let timer = setInterval(function () {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                obj.innerHTML = current.toLocaleString();
            }, stepTime);
        }

        function populateKecamatanFilter() {
            const filterSelect = document.getElementById('filterKecamatan');
            const currentVal = filterSelect.value;
            const kecamatans = new Set();

            proposalData.forEach(row => {
                const len = row.length;
                let kec = '';
                if (len >= 7) kec = row[5];
                else if (len >= 6) kec = row[4];
                else if (len > 3) kec = row[3]; // legacy fallback

                if (kec && kec.trim() !== '') {
                    kecamatans.add(kec.trim());
                }
            });

            filterSelect.innerHTML = '<option value="">Semua Kecamatan</option>';
            Array.from(kecamatans).sort().forEach(kec => {
                const option = document.createElement('option');
                option.value = kec;
                option.innerText = kec;
                filterSelect.appendChild(option);
            });

            if (currentVal) filterSelect.value = currentVal;
        }

        function filterDataAndRender() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterKec = document.getElementById('filterKecamatan').value;
            const filterStatus = document.getElementById('filterStatus').value;

            filteredRows = proposalData.filter(r => {
                // Normalize
                const len = r.length;
                let npsn = '', nama = '', kec = '', judul = '';
                if (len >= 7) {
                    npsn = r[3]; nama = r[4]; kec = r[5]; judul = r[6];
                } else {
                    // Best effort legacy
                    if (r[3] && !isNaN(r[3])) { npsn = r[3]; nama = r[4]; kec = r[5]; judul = r[6]; } // 7-col
                    else { nama = r[3]; kec = r[4]; judul = r[5]; } // 6-col
                }

                // Check Status Match
                const npsnKey = String(npsn).trim();
                const isPenerima = bantuanDataMap[npsnKey];

                let matchesStatus = true;
                if (filterStatus === 'penerima') {
                    matchesStatus = !!isPenerima;
                } else if (filterStatus === 'belum') {
                    matchesStatus = !isPenerima;
                }

                const matchesSearch = (npsn || '').toString().toLowerCase().includes(searchTerm) ||
                    (nama || '').toString().toLowerCase().includes(searchTerm) ||
                    (judul || '').toString().toLowerCase().includes(searchTerm);

                const matchesKec = filterKec === "" || (kec || '').toString() === filterKec;

                return matchesSearch && matchesKec && matchesStatus;
            });

            // Sorting Logic
            if (currentSort.col) {
                filteredRows.sort((a, b) => {
                    // Extract Values Helper
                    const getVal = (row, col) => {
                        const len = row.length;
                        let npsn = '', nama = '', kec = '', judul = '';
                        // Normalize row
                        if (len >= 7) { npsn = row[3]; nama = row[4]; kec = row[5]; judul = row[6]; }
                        else if (len >= 6 && !isNaN(row[3])) { npsn = row[3]; nama = row[4]; kec = row[5]; judul = row[6]; } // 7-col
                        else { nama = row[3]; kec = row[4]; judul = row[5]; } // 6-col

                        const npsnKey = String(npsn || '').trim();
                        const matched = bantuanDataMap[npsnKey];

                        switch (col) {
                            case 'no': return 0; // Handled by index currently, but sorting by original index possible
                            case 'npsn': return npsnKey;
                            case 'nama': return (nama || '').toLowerCase();
                            case 'kecamatan': return (kec || '').toLowerCase();
                            case 'judul': return (judul || '').toLowerCase();
                            case 'status': return matched ? 1 : 0; // 1 = Penerima, 0 = Belum
                            case 'sumber': return matched && matched.sumberDana ? matched.sumberDana.join(' ').toLowerCase() : '';
                            case 'kegiatan': return matched && matched.kegiatan ? matched.kegiatan.join(' ').toLowerCase() : '';
                            default: return '';
                        }
                    };

                    const valA = getVal(a, currentSort.col);
                    const valB = getVal(b, currentSort.col);

                    if (valA < valB) return currentSort.dir === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSort.dir === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            currentPage = 1;
            renderTable();
            updatePaginationInfo();
            updateSortIcons();
        }

        function sortTable(col) {
            if (currentSort.col === col) {
                currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.col = col;
                currentSort.dir = 'asc'; // Default new col to asc (except status maybe?)
                if (col === 'status') currentSort.dir = 'desc'; // Status default desc (Penerima first)
            }
            filterDataAndRender();
        }

        function updateSortIcons() {
            // Reset all
            document.querySelectorAll('.sort-icon').forEach(el => {
                el.innerText = 'unfold_more';
                el.classList.remove('text-primary', 'font-bold');
                el.classList.add('text-gray-400');
            });

            // Set active
            const icon = document.getElementById('sort-' + currentSort.col);
            if (icon) {
                icon.innerText = currentSort.dir === 'asc' ? 'expand_less' : 'expand_more';
                icon.classList.remove('text-gray-400');
                icon.classList.add('text-primary', 'font-bold');
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (filteredRows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-5 py-4 text-center">Tidak ada data ditemukan.</td></tr>';
                return;
            }

            // Pagination Logic
            let startIndex = (currentPage - 1) * rowsPerPage;
            let endIndex = startIndex + rowsPerPage;
            if (rowsPerPage === -1) { startIndex = 0; endIndex = filteredRows.length; }

            const pageRows = filteredRows.slice(startIndex, endIndex);

            pageRows.forEach((r, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-[#f8fafc] dark:hover:bg-[#1e293b] transition-colors";

                const rowNum = startIndex + index + 1;

                // Extraction
                const len = r.length;
                let npsn = '', nama = '', kec = '', judul = '';
                let tglProp = '', tglTerima = '';

                if (len >= 7) {
                    tglProp = r[1]; tglTerima = r[2];
                    npsn = r[3]; nama = r[4]; kec = r[5]; judul = r[6];
                }
                else if (len >= 6 && !isNaN(r[3])) {
                    npsn = r[3]; nama = r[4]; kec = r[5]; judul = r[6];
                    // Best guess indices for legacy if needed or leave empty
                }
                else { nama = r[3]; kec = r[4]; judul = r[5]; }

                // Cross Reference & Aggregation
                const npsnKey = String(npsn).trim();
                const matched = bantuanDataMap[npsnKey];

                let badge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">-</span>';
                let sumberDana = '-';
                let kegiatan = '-';

                if (matched) {
                    badge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">Penerima</span>';
                    if (matched.sumberDana.length > 0) sumberDana = matched.sumberDana.join(', ');
                    else sumberDana = 'Tidak Diketahui';
                    if (matched.kegiatan.length > 0) kegiatan = matched.kegiatan.join(', ');
                }

                if (typeof window.columnVisibility === 'undefined') {
                    // Default visible: No, NPSN, Nama, Kec, Judul(6), Status(7), Sumber(8), Keg(9). Dates hidden (4,5)
                    window.columnVisibility = [true, true, true, true, false, false, true, true, true, true];
                }

                // Helper to hide if needed
                const isHidden = (idx) => !window.columnVisibility[idx] ? 'hidden' : '';

                tr.innerHTML = `
                    <td class="px-3 py-3 text-[#637588] dark:text-[#94a3b8] align-top ${isHidden(0)}">${rowNum}</td>
                    <td class="px-3 py-3 text-[#637588] dark:text-[#94a3b8] font-mono align-top ${isHidden(1)}">${npsn || '-'}</td>
                    <td class="px-3 py-3 font-medium text-gray-900 dark:text-white whitespace-normal align-top min-w-[150px] ${isHidden(2)}">${nama || '-'}</td>
                    <td class="px-3 py-3 text-[#637588] dark:text-[#94a3b8] whitespace-normal align-top ${isHidden(3)}">${kec || '-'}</td>
                    <td class="px-3 py-3 text-[#637588] dark:text-[#94a3b8] whitespace-nowrap align-top ${isHidden(4)}">${formatDate(tglProp)}</td>
                    <td class="px-3 py-3 text-[#637588] dark:text-[#94a3b8] whitespace-nowrap align-top ${isHidden(5)}">${formatDate(tglTerima)}</td>
                    <td class="px-3 py-3 text-[#637588] dark:text-[#94a3b8] whitespace-normal align-top min-w-[200px] ${isHidden(6)}">${judul || '-'}</td>
                    <td class="px-3 py-3 whitespace-nowrap align-top ${isHidden(7)}">${badge}</td>
                    <td class="px-3 py-3 text-[#637588] dark:text-[#94a3b8] font-semibold whitespace-normal align-top ${isHidden(8)}">${sumberDana}</td>
                    <td class="px-3 py-3 text-[#637588] dark:text-[#94a3b8] whitespace-normal align-top min-w-[150px] ${isHidden(9)}">${kegiatan}</td>
                `;
                tbody.appendChild(tr);
            });

            updatePaginationInfo();
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '-';
            return new Intl.DateTimeFormat('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            }).format(date);
        }

        // --- Column Visibility Logic ---
        function toggleColumn(index) {
            if (typeof window.columnVisibility === 'undefined') {
                window.columnVisibility = [true, true, true, true, false, false, true, true, true, true];
            }
            window.columnVisibility[index] = !window.columnVisibility[index];
            const isVisible = window.columnVisibility[index];

            const table = document.getElementById('proposalTable');
            const header = table.querySelectorAll('thead th')[index];
            const rows = table.querySelectorAll('tbody tr');

            if (header) {
                if (isVisible) header.classList.remove('hidden');
                else header.classList.add('hidden');
            }

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > index) {
                    if (isVisible) cells[index].classList.remove('hidden');
                    else cells[index].classList.add('hidden');
                }
            });
        }

        function exportExcel() {
            if (!filteredRows || filteredRows.length === 0) {
                showToast("Tidak ada data untuk diexport", "info");
                return;
            }

            if (typeof window.columnVisibility === 'undefined') {
                window.columnVisibility = [true, true, true, true, false, false, true, true, true, true];
            }

            const columns = [
                { header: "No", isVisible: window.columnVisibility[0], getter: (row, i) => i + 1 },
                { header: "NPSN", isVisible: window.columnVisibility[1], getter: (row) => { const len = row.length; return len >= 7 ? row[3] : (len >= 6 ? row[3] : '-'); } },
                { header: "Nama Sekolah", isVisible: window.columnVisibility[2], getter: (row) => { const len = row.length; return len >= 7 ? row[4] : (len >= 6 ? row[4] : (len > 3 ? row[3] : '-')); } },
                { header: "Kecamatan", isVisible: window.columnVisibility[3], getter: (row) => { const len = row.length; return len >= 7 ? row[5] : (len >= 6 ? row[5] : (len > 3 ? row[4] : '-')); } },
                { header: "Tanggal Proposal", isVisible: window.columnVisibility[4], getter: (row) => row.length >= 7 ? formatDate(row[1]) : '-' },
                { header: "Tanggal Diterima", isVisible: window.columnVisibility[5], getter: (row) => row.length >= 7 ? formatDate(row[2]) : '-' },
                { header: "Judul Proposal", isVisible: window.columnVisibility[6], getter: (row) => { const len = row.length; return len >= 7 ? row[6] : (len >= 6 ? row[6] : (len > 3 ? row[5] : '-')); } },
                {
                    header: "Status", isVisible: window.columnVisibility[7], getter: (row) => {
                        // Helper extraction
                        let npsn = ''; const len = row.length;
                        if (len >= 7) npsn = row[3]; else if (len >= 6) npsn = row[3];
                        return bantuanDataMap[String(npsn).trim()] ? 'Penerima' : '-';
                    }
                },
                {
                    header: "Sumber Dana", isVisible: window.columnVisibility[8], getter: (row) => {
                        let npsn = ''; const len = row.length; if (len >= 7) npsn = row[3]; else if (len >= 6) npsn = row[3];
                        const m = bantuanDataMap[String(npsn).trim()]; return m && m.sumberDana.length > 0 ? m.sumberDana.join(', ') : '-';
                    }
                },
                {
                    header: "Kegiatan", isVisible: window.columnVisibility[9], getter: (row) => {
                        let npsn = ''; const len = row.length; if (len >= 7) npsn = row[3]; else if (len >= 6) npsn = row[3];
                        const m = bantuanDataMap[String(npsn).trim()]; return m && m.kegiatan.length > 0 ? m.kegiatan.join(', ') : '-';
                    }
                }
            ];

            const activeColumns = columns.filter(c => c.isVisible);

            const dataToExport = filteredRows.map((row, index) => {
                const rowObj = {};
                activeColumns.forEach(col => {
                    rowObj[col.header] = col.getter(row, index);
                });
                return rowObj;
            });

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Status Bantuan");
            XLSX.writeFile(wb, "Status_Bantuan_Proposal.xlsx");
        }

        function exportPDF() {
            if (!filteredRows || filteredRows.length === 0) {
                showToast("Tidak ada data untuk diexport", "info");
                return;
            }

            if (typeof window.columnVisibility === 'undefined') {
                window.columnVisibility = [true, true, true, true, false, false, true, true, true, true];
            }

            const columns = [
                { header: "No", isVisible: window.columnVisibility[0], getter: (row, i) => i + 1 },
                { header: "NPSN", isVisible: window.columnVisibility[1], getter: (row) => { const len = row.length; return len >= 7 ? row[3] : (len >= 6 ? row[3] : '-'); } },
                { header: "Sekolah", isVisible: window.columnVisibility[2], getter: (row) => { const len = row.length; return len >= 7 ? row[4] : (len >= 6 ? row[4] : (len > 3 ? row[3] : '-')); } },
                { header: "Kecamatan", isVisible: window.columnVisibility[3], getter: (row) => { const len = row.length; return len >= 7 ? row[5] : (len >= 6 ? row[5] : (len > 3 ? row[4] : '-')); } },
                { header: "Tgl Prop.", isVisible: window.columnVisibility[4], getter: (row) => row.length >= 7 ? formatDate(row[1]) : '-' },
                { header: "Tgl Terima", isVisible: window.columnVisibility[5], getter: (row) => row.length >= 7 ? formatDate(row[2]) : '-' },
                { header: "Judul", isVisible: window.columnVisibility[6], getter: (row) => { const len = row.length; return len >= 7 ? row[6] : (len >= 6 ? row[6] : (len > 3 ? row[5] : '-')); } },
                {
                    header: "Status", isVisible: window.columnVisibility[7], getter: (row) => {
                        let npsn = ''; const len = row.length; if (len >= 7) npsn = row[3]; else if (len >= 6) npsn = row[3];
                        return bantuanDataMap[String(npsn).trim()] ? 'Penerima' : '-';
                    }
                },
                {
                    header: "Sumber", isVisible: window.columnVisibility[8], getter: (row) => {
                        let npsn = ''; const len = row.length; if (len >= 7) npsn = row[3]; else if (len >= 6) npsn = row[3];
                        const m = bantuanDataMap[String(npsn).trim()]; return m && m.sumberDana.length > 0 ? m.sumberDana.join(', ') : '-';
                    }
                },
                {
                    header: "Kegiatan", isVisible: window.columnVisibility[9], getter: (row) => {
                        let npsn = ''; const len = row.length; if (len >= 7) npsn = row[3]; else if (len >= 6) npsn = row[3];
                        const m = bantuanDataMap[String(npsn).trim()]; return m && m.kegiatan.length > 0 ? m.kegiatan.join(', ') : '-';
                    }
                }
            ];

            const activeColumns = columns.filter(c => c.isVisible);
            const head = [activeColumns.map(c => c.header)];
            const body = filteredRows.map((row, index) => {
                return activeColumns.map(col => col.getter(row, index));
            });

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');

            doc.setFontSize(16);
            doc.text("Status Bantuan Proposal", 14, 15);
            doc.setFontSize(10);
            const dateStr = new Date().toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
            doc.text(`Tanggal Export: ${dateStr}`, 14, 22);

            // Dynamic Column Styles
            const columnStyles = {};
            activeColumns.forEach((col, index) => {
                if (col.header === 'Sekolah') columnStyles[index] = { cellWidth: 35 };
                if (col.header === 'Judul') columnStyles[index] = { cellWidth: 70 }; // Increased from 40 to 70
                if (col.header === 'Kegiatan') columnStyles[index] = { cellWidth: 40 };
                if (col.header === 'Tgl Prop.' || col.header === 'Tgl Terima') columnStyles[index] = { cellWidth: 28 };
            });

            doc.autoTable({
                head: head,
                body: body,
                startY: 25,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [19, 127, 236] },
                alternateRowStyles: { fillColor: [240, 242, 244] },
                margin: { top: 25 },
                columnStyles: columnStyles
            });

            doc.save("Status_Bantuan_Proposal.pdf");
        }

        function updatePaginationInfo() {
            const tableInfo = document.getElementById('tableInfo');
            const total = filteredRows.length;
            let startIndex = (currentPage - 1) * rowsPerPage + 1;
            let endIndex = Math.min(startIndex + rowsPerPage - 1, total);

            if (rowsPerPage === -1) { startIndex = 1; endIndex = total; }
            if (total === 0) { startIndex = 0; endIndex = 0; }

            tableInfo.innerText = `Menampilkan ${startIndex} sampai ${endIndex} dari ${total} entri`;

            document.getElementById('btnPrev').disabled = currentPage === 1;

            const maxPage = rowsPerPage === -1 ? 1 : Math.ceil(total / rowsPerPage);
            document.getElementById('btnNext').disabled = currentPage === maxPage || total === 0;
        }

        // Event Listeners
        document.getElementById('searchInput').addEventListener('input', filterDataAndRender);
        document.getElementById('filterKecamatan').addEventListener('change', filterDataAndRender);
        document.getElementById('filterStatus').addEventListener('change', filterDataAndRender);
        document.getElementById('entriesSelect').addEventListener('change', (e) => {
            rowsPerPage = parseInt(e.target.value);
            currentPage = 1;
            renderTable();
        });
        document.getElementById('btnPrev').addEventListener('click', () => {
            if (currentPage > 1) { currentPage--; renderTable(); }
        });
        document.getElementById('btnNext').addEventListener('click', () => {
            const maxPage = Math.ceil(filteredRows.length / rowsPerPage);
            if (currentPage < maxPage) { currentPage++; renderTable(); }
        });

        function confirmLogout(event) {
            event.preventDefault(); // Prevent default link behavior
            if (typeof showConfirmToast === 'function') {
                showConfirmToast("Apakah Anda yakin ingin keluar?", () => {
                    window.location.href = "Index.html"; // Or your logout page
                });
            } else {
                if (confirm("Apakah Anda yakin ingin keluar?")) {
                    window.location.href = "Index.html";
                }
            }
        }

        // Basic Toast Implementation if missing (since we didn't copy strict utility functions file)
        function showConfirmToast(message, onConfirm) {
            // Check if existing toast/confirm exists or create simple confirm content
            // Assuming the CSS/Layout supports it or we use browser confirm fallback which is done in wrapper.
            // But let's verify if `daftar_proposal.html` had a nice toast. It did. 
            // I should have copied it. For now, fallback to browser confirm inside wrapper.
            if (confirm(message)) {
                onConfirm();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>

</html>